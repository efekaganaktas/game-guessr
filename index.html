<!DOCTYPE html>
<html class="dark" lang="tr">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>GameGuessr - T√ºrk√ße</title>
    
    <meta name="description" content="Steam yorumlarƒ±ndan oyunu tahmin et!">
    <link rel="icon" type="image/png" href="/logo.png">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FKSF680D58"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-FKSF680D58');
    </script>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#66c0f4",
              "background-dark": "#1b2838",
              "container-dark": "#2a475e",
              "steam-darker": "#171a21",
              "steam-text-dim": "#91b5ca",
              "steam-success": "#a3cf00",
              "steam-error": "#c53232",
            },
            fontFamily: { "display": ["Inter", "sans-serif"] },
          },
        },
      }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #171a21; color: #c7d5e0; }
        .bg-gradient-steam { background-image: linear-gradient(to right, #66c0f4, #4a95c2); }
        .screen-section { display: none; }
        .screen-section.active { display: flex; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Autocomplete Listesi */
        #suggestion-list {
            position: absolute;
            background: #2a475e;
            border: 1px solid #66c0f4;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            border-radius: 0 0 8px 8px;
            display: none;
        }
        #suggestion-list div {
            padding: 10px;
            cursor: pointer;
            color: white;
        }
        #suggestion-list div:hover {
            background-color: #66c0f4;
            color: black;
        }

        /* Bulanƒ±k Resim ƒ∞pucu */
        .blur-hint {
            filter: blur(15px);
            transition: filter 0.5s;
        }
        .blur-hint:hover {
            filter: blur(5px); /* √úst√ºne gelince biraz netle≈üir */
        }
    </style>
</head>
<body class="h-screen overflow-x-hidden flex flex-col">

    <div id="screen-home" class="screen-section h-full flex-col items-center justify-center p-4 relative">
        <div class="absolute inset-0 z-0 bg-[url('https://images.unsplash.com/photo-1612287232817-60f8f6a92f81?fit=max&fm=jpg&q=80&w=1080')] bg-cover bg-center opacity-20 blur-sm"></div>
        <div class="z-10 flex flex-col items-center gap-6">
            <h1 class="text-6xl font-black text-white drop-shadow-lg" style="font-family: 'Arial Black', sans-serif;">GameGuessr</h1>
            <div class="bg-container-dark/90 p-8 rounded-2xl shadow-2xl border border-white/10 w-full max-w-sm flex flex-col gap-4">
                <button onclick="startFlow()" class="w-full h-14 bg-gradient-steam text-[#1b2838] text-xl font-bold rounded-xl hover:scale-105 transition">OYNA</button>
            </div>
        </div>
    </div>

    <div id="screen-login" class="screen-section h-full flex-col items-center justify-center p-4">
        <div class="bg-container-dark p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-white mb-4 text-center">Oyuncu Adƒ±</h2>
            <input id="usernameInput" class="w-full rounded-lg bg-[#1b2838] border-none p-4 text-white text-center focus:ring-2 focus:ring-primary" placeholder="ƒ∞sminiz..." />
            <button onclick="loginUser()" class="w-full mt-4 h-12 bg-primary text-[#1b2838] font-bold rounded-lg hover:bg-white">Devam Et</button>
        </div>
    </div>

    <div id="screen-category" class="screen-section flex-col min-h-screen">
        <header class="flex justify-between items-center p-4 bg-steam-darker border-b border-white/10">
            <h2 class="text-xl font-bold text-primary cursor-pointer" onclick="showScreen('screen-home')">GameGuessr</h2>
            <button onclick="logout()" class="text-xs bg-container-dark px-3 py-1 rounded text-white">√áƒ±kƒ±≈ü</button>
        </header>
        <main class="p-6 flex-1 flex flex-col items-center">
            <h2 class="text-3xl font-black text-white mb-6">Kategori Se√ß</h2>
            <div id="categoryGrid" class="grid grid-cols-[repeat(auto-fit,minmax(160px,1fr))] gap-4 w-full max-w-4xl"></div>
        </main>
    </div>

    <div id="screen-loading" class="screen-section h-full flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-primary font-bold">Veriler √áekiliyor...</p>
    </div>

    <div id="screen-game" class="screen-section flex-col min-h-screen">
        <header class="flex justify-between items-center p-4 bg-steam-darker border-b border-white/10">
            <div class="text-xs text-steam-text-dim">Kategori: <span id="gameCategoryDisplay" class="text-primary font-bold">...</span></div>
            <div class="font-bold text-white"><span id="scoreDisplay" class="text-primary">0</span> Puan</div>
            <div class="text-xs text-white"><span id="gameProgress">1/10</span></div>
        </header>

        <main class="flex flex-col items-center p-4 w-full max-w-3xl mx-auto gap-6 flex-1">
            
            <div id="hintImageArea" class="hidden w-full h-40 bg-black rounded-lg overflow-hidden relative flex justify-center items-center">
                <img id="hintImage" src="" class="h-full w-auto object-cover blur-hint opacity-70">
                <p class="absolute text-white font-bold drop-shadow-md pointer-events-none">G√ñRSEL ƒ∞PUCU (Kapak)</p>
            </div>

            <div class="w-full bg-container-dark p-6 rounded-lg shadow-lg relative border border-white/5 min-h-[180px] flex flex-col justify-center">
                <div class="absolute top-2 right-2 text-[10px] bg-black/40 px-2 py-1 rounded text-primary">Steam Yorumu</div>
                <p id="reviewText" class="text-white text-lg italic leading-relaxed text-center">"..."</p>
                <div class="mt-4 pt-4 border-t border-white/10 flex justify-center gap-4 text-xs text-steam-text-dim">
                    <span id="playtimeText">üïê ... saat</span>
                    <span>üëç Tavsiye Ediliyor</span>
                </div>
            </div>

            <div class="flex gap-2 w-full justify-center">
                <button onclick="useHint('image')" id="btnHintImage" class="px-4 py-2 bg-purple-700 hover:bg-purple-600 text-white text-xs font-bold rounded transition">üñºÔ∏è G√∂rsel (-15 P)</button>
                <button onclick="useHint('word')" id="btnHintWord" class="px-4 py-2 bg-orange-700 hover:bg-orange-600 text-white text-xs font-bold rounded transition">üî§ Harf (-10 P)</button>
                <button onclick="nextReview()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white text-xs font-bold rounded transition">üîÑ Yeni Yorum (-5 P)</button>
            </div>

            <div class="w-full max-w-md relative">
                <input id="guessInput" class="w-full h-14 bg-black/40 border border-white/10 rounded-lg p-4 text-white placeholder:text-gray-500 focus:border-primary focus:ring-0" placeholder="Oyun ismini yaz..." autocomplete="off"/>
                
                <div id="suggestion-list"></div>
                
                <p id="wordHintText" class="text-center text-primary font-mono mt-2 tracking-widest text-sm h-5"></p>
            </div>

            <div class="flex w-full max-w-md gap-3">
                <button onclick="checkGuess()" class="flex-1 h-12 bg-primary text-[#1b2838] font-bold rounded-lg hover:bg-white transition">TAHMƒ∞N ET</button>
                <button onclick="passGame()" class="px-6 bg-steam-error text-white font-bold rounded-lg hover:bg-red-600 transition">PAS</button>
            </div>

            <p id="feedbackMsg" class="h-6 text-lg font-bold text-center"></p>
        </main>
    </div>

    <div id="screen-result" class="screen-section flex-col min-h-screen p-4 items-center">
        <h2 class="text-4xl font-black text-white mb-2">OYUN Bƒ∞TTƒ∞</h2>
        <p id="finalScoreDisplay" class="text-xl text-primary mb-8">Puan: 0</p>
        
        <div id="resultGrid" class="grid grid-cols-[repeat(auto-fit,minmax(120px,1fr))] gap-3 w-full max-w-4xl mb-8"></div>
        
        <h3 class="text-xl font-bold text-white mb-4 w-full max-w-2xl">Sƒ±ralama</h3>
        <div class="w-full max-w-2xl bg-container-dark rounded-lg overflow-hidden border border-white/10 mb-8">
            <table class="w-full text-left text-sm">
                <thead class="bg-steam-darker text-primary"><tr><th class="p-3">#</th><th>Oyuncu</th><th>Puan</th></tr></thead>
                <tbody id="leaderboardBody"></tbody>
            </table>
        </div>

        <button onclick="initCategories()" class="px-8 py-3 bg-primary text-[#1b2838] font-bold rounded-lg hover:bg-white">Kategorilere D√∂n</button>
    </div>

    <script>
        const API_URL = '/api'; 
        let allGameNames = []; // Autocomplete i√ßin liste

        const CATEGORIES = [
            { name: "Karƒ±≈üƒ±k", img: "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/4000/header.jpg" },
            { name: "Aksiyon", img: "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/1091500/header.jpg" },
            { name: "RPG", img: "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/292030/header.jpg" },
            { name: "Strateji", img: "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/289070/header.jpg" },
            { name: "Korku", img: "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/739630/header.jpg" },
            { name: "Macera", img: "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/271590/header.jpg" },
            { name: "Sim√ºlasyon", img: "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/227300/header.jpg" },
            { name: "√áok Oyunculu", img: "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/730/header.jpg" },
            { name: "Komedi", img: "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/265930/header.jpg" }
        ];

        let state = {
            username: "", score: 0, currentCategoryName: "", games: [], 
            currentGameIndex: 0, currentReviewIndex: 0, currentPot: 100, history: []
        };

        window.onload = async function() {
            showScreen('screen-home');
            // Oyun isimlerini arka planda √ßek (Autocomplete i√ßin)
            try {
                const res = await fetch(`${API_URL}/all-games`);
                allGameNames = await res.json();
            } catch(e) { console.log("Liste √ßekilemedi"); }
        };

        function showScreen(id) {
            document.querySelectorAll('.screen-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- Gƒ∞Rƒ∞≈û & MEN√ú ---
        function startFlow() {
            const stored = localStorage.getItem('steam_username');
            if(stored) { state.username = stored; initCategories(); }
            else { showScreen('screen-login'); }
        }
        function loginUser() {
            const val = document.getElementById('usernameInput').value.trim();
            if(!val) return;
            localStorage.setItem('steam_username', val);
            state.username = val;
            initCategories();
        }
        function logout() { localStorage.removeItem('steam_username'); showScreen('screen-home'); }

        function initCategories() {
            document.getElementById('welcomeText').innerText = `Ho≈ügeldin, ${state.username}`;
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = "";
            CATEGORIES.forEach(cat => {
                const div = document.createElement('div');
                div.className = "relative h-32 rounded-lg overflow-hidden cursor-pointer group border border-white/10 hover:border-primary transition-all";
                div.onclick = () => fetchGames(cat.name);
                div.innerHTML = `
                    <img src="${cat.img}" class="absolute inset-0 w-full h-full object-cover group-hover:scale-110 transition duration-500">
                    <div class="absolute inset-0 bg-black/60 group-hover:bg-black/40 flex items-center justify-center">
                        <span class="text-white font-bold text-lg uppercase tracking-wider">${cat.name}</span>
                    </div>
                `;
                grid.appendChild(div);
            });
            showScreen('screen-category');
        }

        async function fetchGames(category) {
            state.currentCategoryName = category;
            showScreen('screen-loading');
            try {
                const res = await fetch(`${API_URL}/game-quiz?category=${encodeURIComponent(category)}`);
                const data = await res.json();
                if(!data || data.length === 0) { alert("Oyun bulunamadƒ±."); showScreen('screen-category'); return; }
                
                state.games = data;
                state.currentGameIndex = 0;
                state.score = 0;
                state.history = [];
                startGame();
            } catch(e) { alert("Hata olu≈ütu."); showScreen('screen-category'); }
        }

        // --- OYUN MEKANƒ∞ƒûƒ∞ ---
        function startGame() { showScreen('screen-game'); loadLevel(); }

        function loadLevel() {
            if(state.currentGameIndex >= state.games.length) { endGame(); return; }
            
            state.currentReviewIndex = 0;
            state.currentPot = 100;
            
            // UI Sƒ±fƒ±rla
            document.getElementById('hintImageArea').classList.add('hidden');
            document.getElementById('wordHintText').innerText = "";
            document.getElementById('btnHintImage').disabled = false;
            document.getElementById('btnHintWord').disabled = false;
            document.getElementById('btnHintImage').classList.remove('opacity-50');
            document.getElementById('btnHintWord').classList.remove('opacity-50');
            
            updateUI();
        }

        function updateUI() {
            const game = state.games[state.currentGameIndex];
            const rev = game.reviews[state.currentReviewIndex];

            document.getElementById('gameCategoryDisplay').innerText = state.currentCategoryName;
            document.getElementById('scoreDisplay').innerText = state.score;
            document.getElementById('gameProgress').innerText = `${state.currentGameIndex + 1}/10`;
            
            document.getElementById('reviewText').innerText = `"${rev.text}"`;
            document.getElementById('reviewCountBadge').innerText = `Yorum ${state.currentReviewIndex + 1}/10`;
            document.getElementById('playtimeText').innerText = `üïê ${rev.playtime} saat`;

            const inp = document.getElementById('guessInput');
            inp.value = "";
            inp.focus();
            document.getElementById('feedbackMsg').innerText = "";
            document.getElementById('suggestion-list').style.display = 'none';
        }

        // --- ƒ∞PU√áLARI ---
        function useHint(type) {
            const game = state.games[state.currentGameIndex];
            
            if (type === 'image') {
                // Puan d√º≈ü
                state.currentPot -= 15;
                if(state.currentPot < 0) state.currentPot = 0;
                
                // G√∂rseli G√∂ster (Bulanƒ±k)
                const area = document.getElementById('hintImageArea');
                const img = document.getElementById('hintImage');
                img.src = game.image;
                area.classList.remove('hidden');
                
                // Butonu pasif yap
                const btn = document.getElementById('btnHintImage');
                btn.disabled = true;
                btn.classList.add('opacity-50');
                
            } else if (type === 'word') {
                // Puan d√º≈ü
                state.currentPot -= 10;
                if(state.currentPot < 0) state.currentPot = 0;

                // Harf sans√ºrl√º g√∂ster (C******* S*****)
                let hiddenName = game.name.replace(/[a-zA-Z0-9]/g, (char, index) => {
                    return index === 0 || game.name[index-1] === ' ' ? char : '*';
                });
                document.getElementById('wordHintText').innerText = hiddenName;

                const btn = document.getElementById('btnHintWord');
                btn.disabled = true;
                btn.classList.add('opacity-50');
            }
        }

        function nextReview() {
            if(state.currentReviewIndex < 9) {
                state.currentReviewIndex++;
                state.currentPot -= 5;
                if(state.currentPot < 0) state.currentPot = 0;
                updateUI();
            } else {
                document.getElementById('feedbackMsg').innerText = "Son ipucu!";
            }
        }

        // --- AUTOCOMPLETE (ARAMA) ---
        const input = document.getElementById('guessInput');
        const list = document.getElementById('suggestion-list');

        input.addEventListener('input', function() {
            const val = this.value.toLowerCase();
            list.innerHTML = '';
            if (!val) { list.style.display = 'none'; return; }

            // Filtrele (En fazla 5 sonu√ß g√∂ster)
            const matches = allGameNames.filter(n => n.toLowerCase().startsWith(val)).slice(0, 5);
            
            if (matches.length > 0) {
                list.style.display = 'block';
                matches.forEach(match => {
                    const div = document.createElement('div');
                    div.innerText = match;
                    div.onclick = function() {
                        input.value = match;
                        list.style.display = 'none';
                        checkGuess(); // Se√ßince direkt tahmin etsin mi? ƒ∞stersen bunu kaldƒ±rƒ±p butona basmasƒ±nƒ± bekleyebilirsin.
                    };
                    list.appendChild(div);
                });
            } else {
                list.style.display = 'none';
            }
        });

        // Dƒ±≈üarƒ± tƒ±klayƒ±nca listeyi kapat
        document.addEventListener('click', function(e) {
            if (e.target !== input && e.target !== list) {
                list.style.display = 'none';
            }
        });

        function checkGuess() {
            const userGuess = input.value.trim().toLowerCase();
            const correctName = state.games[state.currentGameIndex].name.toLowerCase();
            const msg = document.getElementById('feedbackMsg');

            // Basit temizlik (noktalama i≈üaretlerini yoksay)
            const cleanUser = userGuess.replace(/[^a-z0-9]/g, "");
            const cleanCorrect = correctName.replace(/[^a-z0-9]/g, "");

            if (cleanUser === cleanCorrect) {
                // DOƒûRU
                state.score += state.currentPot;
                state.history.push({...state.games[state.currentGameIndex], isCorrect: true});
                msg.innerText = "DOƒûRU!";
                msg.className = "h-6 text-lg font-bold text-center text-steam-success";
                setTimeout(() => { 
                    state.currentGameIndex++;
                    loadLevel();
                }, 1000);
            } else {
                msg.innerText = "Yanlƒ±≈ü!";
                msg.className = "h-6 text-lg font-bold text-center text-steam-error";
            }
        }

        function passGame() {
            state.history.push({...state.games[state.currentGameIndex], isCorrect: false});
            state.currentGameIndex++;
            loadLevel();
        }

        // --- SONU√á ---
        async function endGame() {
            await fetch(`${API_URL}/submit-score`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: state.username, category: state.currentCategoryName, score: state.score})
            });
            
            const res = await fetch(`${API_URL}/leaderboard?category=${encodeURIComponent(state.currentCategoryName)}`);
            const leaderboard = await res.json();

            showScreen('screen-result');
            document.getElementById('finalScoreDisplay').innerText = `Puan: ${state.score}`;
            
            const grid = document.getElementById('resultGrid');
            grid.innerHTML = "";
            state.history.forEach(h => {
                const div = document.createElement('div');
                div.className = `relative aspect-video bg-black rounded border-2 ${h.isCorrect ? 'border-steam-success' : 'border-steam-error'}`;
                div.innerHTML = `<img src="${h.image}" class="w-full h-full object-cover opacity-70"><div class="absolute bottom-0 w-full bg-black/80 text-white text-[10px] p-1 text-center truncate">${h.name}</div>`;
                grid.appendChild(div);
            });

            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = "";
            leaderboard.forEach((p, i) => {
                tbody.innerHTML += `<tr class="border-b border-white/5"><td class="p-2">${i+1}</td><td>${p.username}</td><td>${p.score}</td></tr>`;
            });
        }
    </script>
</body>
</html>